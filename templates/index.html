<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Vulnerability Scanner</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        /* Result styling based on risk levels */
        .result-critical { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .result-high { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .result-medium { background-color: #dbeafe; border-left: 4px solid #3b82f6; }
        .result-low { background-color: #ecfdf5; border-left: 4px solid #10b981; }
        .btn-primary { 
            background-color: #4f46e5; color: white; transition: background-color 0.3s;
            border-radius: 8px; padding: 10px 15px; font-weight: 600;
        }
        .btn-primary:hover { background-color: #4338ca; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
            IoT Vulnerability Scanner
            <svg class="w-6 h-6 ml-3 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v3h8z"></path></svg>
        </h1>
        
        <div class="card p-6 mb-8">
            <form id="scanForm" action="/" method="POST" class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
                <input 
                    type="text" 
                    name="target" 
                    id="target" 
                    placeholder="Enter IP or Range (e.g., 192.168.1.1 or 192.168.1.1-254)"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                    required
                >
                <button type="submit" id="scanButton" class="btn-primary">
                    <span id="buttonText">Start Scan</span>
                </button>
                <button type="button" id="mockButton" class="btn-primary bg-green-500 hover:bg-green-600" onclick="runMock()">
                    Run Mock Test
                </button>
            </form>
            <p class="text-xs text-gray-500 mt-2">Note: Scanning large ranges may take time and consume server resources.</p>
        </div>

        <div id="resultsSection" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Scan Results</h2>
            <div id="resultsContainer" class="space-y-4">
                <!-- Results will be injected here -->
            </div>
            <div id="noResults" class="hidden card p-4 text-center text-gray-500">
                No critical vulnerabilities or weak credentials found.
            </div>
        </div>

        <div id="loading" class="hidden text-center card p-4">
            <svg class="animate-spin h-5 w-5 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-indigo-500">Scanning in progress... Please wait.</p>
        </div>
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scanForm = document.getElementById('scanForm');
            const targetInput = document.getElementById('target');
            const scanButton = document.getElementById('scanButton');
            const buttonText = document.getElementById('buttonText');
            const loading = document.getElementById('loading');
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');

            function showLoading() {
                loading.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                scanButton.disabled = true;
                buttonText.textContent = 'Scanning...';
            }

            function hideLoading() {
                loading.classList.add('hidden');
                scanButton.disabled = false;
                buttonText.textContent = 'Start Scan';
            }
            
            function runMock() {
                // We use a simple fetch call instead of form submission for clean AJAX handling
                startScan(null, true);
            }
            window.runMock = runMock; // Expose to global scope for button click

            scanForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                startScan(targetInput.value.trim(), false);
            });
            
            async function startScan(target, isMock) {
                if (!target && !isMock) {
                    // Using console.error instead of alert()
                    console.error('Validation Error: Please enter a target IP or range.');
                    return;
                }
                
                showLoading();

                let url = '/scan';
                let data = {};

                if (isMock) {
                    url = '/scan?mock=true';
                } else {
                    data = { target: target };
                }
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: isMock ? JSON.stringify({}) : JSON.stringify(data),
                    });

                    // Handle non-200 responses
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server returned status ${response.status}`);
                    }
                    
                    const resultData = await response.json();
                    
                    hideLoading();
                    displayResults(resultData.results);

                } catch (error) {
                    console.error('Scan Error:', error);
                    hideLoading();
                    resultsContainer.innerHTML = `<div class="card p-4 bg-red-100 text-red-700 font-medium">Error: ${error.message || 'An unknown error occurred during the scan.'}</div>`;
                    resultsSection.classList.remove('hidden');
                }
            }
            
            function getRiskClass(risk) {
                switch(risk) {
                    case 'CRITICAL': return 'result-critical';
                    case 'HIGH': return 'result-high';
                    case 'MEDIUM': return 'result-medium';
                    default: return 'result-low';
                }
            }

            function displayResults(results) {
                resultsContainer.innerHTML = '';
                if (!results || results.length === 0) {
                    noResults.classList.remove('hidden');
                    resultsSection.classList.remove('hidden');
                    return;
                }
                
                noResults.classList.add('hidden');
                resultsSection.classList.remove('hidden');

                results.forEach(finding => {
                    const riskClass = getRiskClass(finding.risk);
                    
                    const detailsHtml = finding.details.map(detail => {
                        const cve = detail.cve && detail.cve !== 'N/A - Default Setup Risk' ? `<span class="font-mono text-xs bg-gray-200 px-1 rounded ml-1">${detail.cve}</span>` : '';
                        
                        return `
                            <li class="mt-2 ml-4 list-disc text-gray-700">
                                <span class="font-medium">${detail.type}:</span> ${detail.description}${cve}
                            </li>
                        `;
                    }).join('');

                    const portInfo = finding.port ? `Port: ${finding.port}` : '';
                    
                    const resultCard = `
                        <div class="card p-4 ${riskClass}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold text-lg text-gray-800">${finding.ip}</span>
                                <span class="px-3 py-1 text-sm font-semibold rounded-full 
                                    ${finding.risk === 'CRITICAL' ? 'bg-red-500 text-white' : 
                                      finding.risk === 'HIGH' ? 'bg-orange-500 text-white' : 
                                      finding.risk === 'MEDIUM' ? 'bg-blue-500 text-white' : 'bg-green-500 text-white'}
                                ">
                                    ${finding.risk}
                                </span>
                            </div>
                            ${portInfo ? `<p class="text-sm text-gray-600 mb-2">${portInfo}</p>` : ''}
                            <ul class="list-none space-y-1">
                                ${detailsHtml}
                            </ul>
                        </div>
                    `;
                    resultsContainer.innerHTML += resultCard;
                });
            }
        });
    </script>
</body>
</html>
