{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Scan Results Report</h2>

{% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
{% elif report %}

    <div class="card mb-4 bg-light summary-card">
        <div class="card-body">
            <h4 class="card-title">Summary</h4>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    Scan Date/Time:
                    <strong>{{ report.summary.timestamp }}</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    Hosts Found:
                    <span class="badge bg-primary rounded-pill">{{ report.summary.hosts_found }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    Total Issues Found:
                    <span class="badge bg-danger rounded-pill">{{ report.summary.total_issues_found }}</span>
                </li>
            </ul>
        </div>
    </div>
    
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Host Overview ({{ report.summary.hosts_found }})</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="vulns-tab" data-bs-toggle="tab" data-bs-target="#vulns" type="button" role="tab" aria-controls="vulns" aria-selected="false">Vulnerability Matches ({{ report.summary.vulnerability_matches_count }})</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="creds-tab" data-bs-toggle="tab" data-bs-target="#creds" type="button" role="tab" aria-controls="creds" aria-selected="false">Weak Credentials ({{ report.summary.weak_credentials_count }})</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">Exposed Files ({{ report.summary.exposed_files_count }})</button>
      </li>
    </ul>
    
    <div class="tab-content pt-3" id="myTabContent">
        
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            {% for host in report.host_overview %}
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5>üñ•Ô∏è {{ host.ip }} <small class="text-muted ms-3">MAC: {{ host.mac }} (Vendor: {{ host.vendor }})</small></h5>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>Hostname:</strong> {{ host.hostname }}</p>
                    <p class="mb-1"><strong>OS Guess:</strong> {{ host.os_fingerprint }}</p>
                    <h6>Open TCP Services:</h6>
                    <ul class="list-group list-group-flush">
                        {% for port, banner in host.tcp_services.items() %}
                        <li class="list-group-item">
                            <span class="badge bg-success me-2">{{ port }}</span> {{ banner if banner else "No Banner" }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="tab-pane fade" id="vulns" role="tabpanel" aria-labelledby="vulns-tab">
            {% for match in report.vulnerability_matches %}
            <div class="card mb-3 issue-card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-danger">{{ match.cve_id }} on {{ match.ip }}:{{ match.port }}</h5>
                    <p class="card-text">{{ match.description }}</p>
                    <ul class="list-inline small">
                        <li class="list-inline-item"><strong>Matched Banner:</strong> <span class="badge bg-secondary">{{ match.banner }}</span></li>
                        <li class="list-inline-item"><strong>Matched Keyword:</strong> <span class="badge bg-info">{{ match.matched_keyword }}</span></li>
                    </ul>
                </div>
            </div>
            {% endfor %}
            {% if not report.vulnerability_matches %}
                <div class="alert alert-success">‚úÖ No vulnerability matches found.</div>
            {% endif %}
        </div>
        
        <div class="tab-pane fade" id="creds" role="tabpanel" aria-labelledby="creds-tab">
            {% for cred in report.weak_credentials %}
            <div class="card mb-3 issue-card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-warning">‚ö†Ô∏è Weak Credentials Found on {{ cred.ip }}:{{ cred.port }}</h5>
                    <p class="card-text">
                        <strong>Service:</strong> {{ cred.service }}<br>
                        <strong>Username:</strong> <span class="text-danger">{{ cred.username }}</span><br>
                        <strong>Password:</strong> <span class="text-danger">{{ cred.password }}</span>
                    </p>
                </div>
            </div>
            {% endfor %}
            {% if not report.weak_credentials %}
                <div class="alert alert-success">‚úÖ No weak/default credentials found.</div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="files" role="tabpanel" aria-labelledby="files-tab">
            {% for file_data in report.exposed_files %}
            <div class="card mb-3 issue-card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-info">üìÑ Exposed File on {{ file_data.ip }}</h5>
                    <p class="card-text">
                        <strong>URL:</strong> <a href="{{ file_data.url }}" target="_blank">{{ file_data.url }}</a><br>
                        <strong>Path:</strong> {{ file_data.path }}<br>
                        <strong>Status Code:</strong> <span class="badge bg-secondary">{{ file_data.status_code }}</span>
                    </p>
                </div>
            </div>
            {% endfor %}
            {% if not report.exposed_files %}
                <div class="alert alert-success">‚úÖ No commonly exposed sensitive files found.</div>
            {% endif %}
        </div>

    </div>
    
{% else %}
    <div class="alert alert-info" role="alert">
        Please run a scan from the home page or ensure a JSON report exists in the 'scan_reports' directory.
    </div>
{% endif %}

{% endblock %}